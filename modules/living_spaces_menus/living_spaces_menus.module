<?php

/**
 * @file
 * Contains functions and hooks for living_spaces_menus.module.
 */

use Drupal\Core\Template\Attribute;
use Drupal\Core\Url;

/**
 * Implements hook_collapsible_menu_alter().
 */
function living_spaces_menus_dom_bootstrap_collapsible_menu_alter(&$build) {
  $spaces_menu_key = 'menu_link_content:436e7a5e-7eb0-4ba7-928c-b9064865f174';
  $have_favorites = FALSE;

  $query = \Drupal::entityTypeManager()->getStorage('group')->getQuery();
  $query->addTag('living_spaces_menus_user_spaces');
  $query->condition('status', 1, '=')
    ->sort('label', 'ASC')
    ->range(0, 8);

  $result = $query->execute();

  if ($result) {
    $groups = \Drupal::entityTypeManager()->getStorage('group')->loadMultiple($result);
  }

  if ($groups) {
    $links = [];

    $user = \Drupal::entityTypeManager()->getStorage('user')->load(\Drupal::currentUser()->id());

    $favorites_list = [];

    foreach ($user->field_favorite_spaces->getValue() as $favorite) {
      $favorites_list[] = $favorite['target_id'];
    }

    $groups_keys = array_keys($groups);
    $favorites_list = array_flip($favorites_list);

    usort($groups_keys, function($a, $b) use($favorites_list) {
      return (isset($favorites_list[$a]) && isset($favorites_list[$b]) ? $favorites_list[$a] - $favorites_list[$b] : -1);
    });

    if ($favorites_list) {
      $have_favorites = TRUE;
    }

    foreach ($groups_keys as $key) {
      if (!array_key_exists($groups[$key]->id(), $favorites_list) && $have_favorites) {
        $have_favorites = FALSE;

        $links['living_spaces_menus.items_delimiter'] = [
          'put_delimiter' => TRUE,
        ];
      }

      $links['living_spaces_menus.space:' . $groups[$key]->id()] = [
        'is_expanded' => FALSE,
        'is_collapsed' => FALSE,
        'in_active_trail' => FALSE,
        'attributes' => new Attribute(),
        'title' => $groups[$key]->label(),
        'url' => Url::fromRoute('entity.group.canonical', ['group' => $groups[$key]->id()]),
        'below' => [],
      ];
    }

    if ($have_favorites) {
      $links['living_spaces_menus.items_delimiter'] = [
        'put_delimiter' => TRUE,
      ];
    }

    array_push($links, end($build['#items'][$spaces_menu_key]['below']));

    $build['#items'][$spaces_menu_key]['below'] = $links;
    $build['#cache']['tags'] = ['user:' . \Drupal::currentUser()->id()];
  }
}
